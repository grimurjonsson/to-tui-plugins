---
phase: 03-ux-polish
plan: 03
type: execute
wave: 1
depends_on: ["03-02"]
files_modified:
  - claude-tasks/src/lib.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees waiting guidance when tasklist is empty (not cleared immediately)"
    - "Guidance only clears when FileChanged events arrive (real tasks)"
    - "InitialScan events do not clear guidance"
  artifacts:
    - path: "claude-tasks/src/lib.rs"
      provides: "Fixed guidance clearing logic that filters by event type"
      contains: "FileChanged"
  key_links:
    - from: "process_sync_events_local"
      to: "clear_guidance"
      via: "Check for FileChanged events before clearing"
      pattern: "SyncEvent::FileChanged"
---

<objective>
Fix guidance clearing logic to only clear when real tasks arrive.

Purpose: Currently guidance is cleared on ANY event including InitialScan, which defeats the purpose of showing "waiting for tasks" guidance when a tasklist is empty.
Output: Guidance persists until actual FileChanged events arrive.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ux-polish/03-VERIFICATION.md
@claude-tasks/src/lib.rs
@claude-tasks/src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix guidance clearing condition to filter by event type</name>
  <files>claude-tasks/src/lib.rs</files>
  <action>
    In process_sync_events_local(), change the guidance clearing logic at lines 139-153.

    Current (flawed):
    ```rust
    let should_clear_guidance = {
        let state = self.state.lock().unwrap();
        state.is_guidance_shown() && !events.is_empty()
    };
    ```

    Change to check for FileChanged events specifically:
    ```rust
    // Only clear guidance when real tasks arrive (FileChanged events)
    // InitialScan and FileRemoved don't indicate new tasks arriving
    let has_file_changed_events = events.iter().any(|e| matches!(e, SyncEvent::FileChanged(_)));
    let should_clear_guidance = {
        let state = self.state.lock().unwrap();
        state.is_guidance_shown() && has_file_changed_events
    };
    ```

    Update the log message (line 152) to be more accurate:
    ```rust
    eprintln!("claude-tasks: Clearing guidance - FileChanged events indicate real tasks arrived");
    ```

    This ensures:
    1. InitialScan (watcher starting up) does NOT clear guidance
    2. FileRemoved (task deleted) does NOT clear guidance
    3. Only FileChanged (new/updated task files) clears guidance
  </action>
  <verify>
    cargo build --release -p claude-tasks
    cargo test -p claude-tasks
    cargo clippy -p claude-tasks -- -D warnings
  </verify>
  <done>
    Guidance clearing logic filters by SyncEvent::FileChanged, InitialScan no longer triggers clearing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit test for guidance clearing filter logic</name>
  <files>claude-tasks/src/lib.rs</files>
  <action>
    Add a module-level test in lib.rs that verifies the event filtering logic works correctly.

    Since process_sync_events_local is a method on ClaudeTasksPlugin and requires complex setup,
    add a simple unit test that validates the core filtering logic separately:

    ```rust
    #[cfg(test)]
    mod tests {
        use super::*;
        use state::SyncEvent;
        use std::path::PathBuf;

        #[test]
        fn test_file_changed_event_detection() {
            // FileChanged should be detected
            let events_with_change = vec![
                SyncEvent::InitialScan,
                SyncEvent::FileChanged(PathBuf::from("/test/1.json")),
            ];
            let has_file_changed = events_with_change.iter().any(|e| matches!(e, SyncEvent::FileChanged(_)));
            assert!(has_file_changed, "Should detect FileChanged event");

            // InitialScan only should not trigger
            let events_initial_only = vec![SyncEvent::InitialScan];
            let has_file_changed = events_initial_only.iter().any(|e| matches!(e, SyncEvent::FileChanged(_)));
            assert!(!has_file_changed, "InitialScan alone should not trigger clearing");

            // FileRemoved only should not trigger
            let events_removed_only = vec![SyncEvent::FileRemoved(PathBuf::from("/test/1.json"))];
            let has_file_changed = events_removed_only.iter().any(|e| matches!(e, SyncEvent::FileChanged(_)));
            assert!(!has_file_changed, "FileRemoved alone should not trigger clearing");
        }
    }
    ```

    Place this test module at the end of lib.rs.
  </action>
  <verify>
    cargo test -p claude-tasks test_file_changed_event_detection -- --nocapture
  </verify>
  <done>
    Unit test verifies that only FileChanged events would trigger guidance clearing
  </done>
</task>

</tasks>

<verification>
1. cargo build --release -p claude-tasks passes
2. cargo test -p claude-tasks passes (all 104+ tests)
3. cargo clippy -p claude-tasks -- -D warnings passes
4. New test test_file_changed_event_detection passes
5. Verify in code: guidance clearing condition now checks for FileChanged events
</verification>

<success_criteria>
- Guidance clearing logic explicitly checks for SyncEvent::FileChanged events
- InitialScan events do NOT trigger guidance clearing
- FileRemoved events do NOT trigger guidance clearing
- Only FileChanged events (real task arrivals) clear guidance
- All tests pass including new test
</success_criteria>

<output>
After completion, create `.planning/phases/03-ux-polish/03-03-SUMMARY.md`
</output>
