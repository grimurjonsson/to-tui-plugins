---
phase: 03-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - claude-tasks/src/guidance.rs
  - claude-tasks/src/state.rs
  - claude-tasks/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Guidance module can create todos that explain plugin state"
    - "State tracks whether guidance is currently shown"
    - "Guidance commands use consistent IDs for lifecycle management"
  artifacts:
    - path: "claude-tasks/src/guidance.rs"
      provides: "Guidance todo creation functions"
      exports: ["create_no_tasklist_guidance", "create_empty_tasklist_guidance", "create_error_guidance", "clear_guidance", "GUIDANCE_IDS"]
    - path: "claude-tasks/src/state.rs"
      provides: "GuidanceState enum and tracking fields"
      contains: "GuidanceState"
  key_links:
    - from: "claude-tasks/src/guidance.rs"
      to: "totui_plugin_interface::FfiCommand"
      via: "CreateTodo, SetTodoMetadata commands"
      pattern: "FfiCommand::CreateTodo"
---

<objective>
Create the guidance module with todo creation functions and add guidance state tracking to SyncState.

Purpose: Establish the foundation for displaying in-context help as todos. Users will see clear instructions when the plugin loads in various states (no tasklists, empty tasklist, errors).

Output: guidance.rs module with creation functions, GuidanceState enum, guidance_shown field in SyncState.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-ux-polish/03-RESEARCH.md
@claude-tasks/src/lib.rs
@claude-tasks/src/state.rs
@claude-tasks/src/commands.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guidance module with todo creation functions</name>
  <files>claude-tasks/src/guidance.rs</files>
  <action>
Create a new guidance.rs module with:

1. **Constants for guidance todo IDs** (for consistent lifecycle management):
   - `GUIDANCE_HEADER_ID`: "claude-guidance-header"
   - `GUIDANCE_NO_TASKLIST_ID`: "claude-guidance-no-tasklist"
   - `GUIDANCE_START_CLAUDE_ID`: "claude-guidance-start-claude"
   - `GUIDANCE_NO_TASKS_ID`: "claude-guidance-no-tasks"
   - `GUIDANCE_TASKS_WILL_APPEAR_ID`: "claude-guidance-tasks-appear"
   - `GUIDANCE_WAITING_HEADER_ID`: "claude-guidance-waiting-header"
   - `GUIDANCE_ERROR_HEADER_ID`: "claude-error-header"
   - `GUIDANCE_ERROR_DETAIL_ID`: "claude-error-detail"
   - `GUIDANCE_ERROR_ACTION_ID`: "claude-error-action"

2. **Message constants** (centralized text):
   - `MSG_HEADER_SETUP_REQUIRED`: "CLAUDE TASKS - Setup Required"
   - `MSG_NO_TASKLISTS`: "No Claude tasklists found in ~/.claude/tasks/"
   - `MSG_START_CLAUDE`: "Start a Claude Code session to create a tasklist"
   - `MSG_NO_TASKS_YET`: "Claude hasn't created any tasks yet"
   - `MSG_TASKS_WILL_APPEAR`: "Tasks will appear here as Claude works"

3. **Functions**:

   a. `create_no_tasklist_guidance() -> Vec<FfiCommand>`
      - Header todo with FfiTodoState::Question state: "CLAUDE TASKS - Setup Required"
      - Child todo: "No Claude tasklists found in ~/.claude/tasks/"
      - Child todo: "Start a Claude Code session to create a tasklist"
      - SetTodoMetadata on header with `{"source":"claude-tasks","type":"guidance"}`

   b. `create_empty_tasklist_guidance(display_name: &str) -> Vec<FfiCommand>`
      - Header todo: "CLAUDE TASKLIST: {display_name} - Waiting for tasks"
      - Child todo: "Claude hasn't created any tasks yet"
      - Child todo: "Tasks will appear here as Claude works"
      - SetTodoMetadata on header with `{"source":"claude-tasks","type":"guidance"}`

   c. `create_error_guidance(title: &str, explanation: &str, action: &str) -> Vec<FfiCommand>`
      - Header todo with FfiTodoState::Exclamation: title
      - Child todo: explanation
      - Child todo: "Action: {action}"
      - SetTodoMetadata on header with `{"source":"claude-tasks","type":"guidance","error":true}`

   d. `clear_guidance() -> Vec<FfiCommand>`
      - Returns DeleteTodo commands for ALL guidance IDs
      - Safe to call even if some IDs don't exist (totui will ignore non-existent deletes)

Use imports: `abi_stable::std_types::{ROption, RString}`, `totui_plugin_interface::{FfiCommand, FfiTodoState}`

Add comprehensive tests for each function verifying:
- Command count
- Content strings
- State values
- Metadata JSON structure
  </action>
  <verify>cargo test --package claude-tasks guidance:: -- --nocapture</verify>
  <done>guidance.rs compiles, all tests pass, functions create correct FfiCommand sequences</done>
</task>

<task type="auto">
  <name>Task 2: Add GuidanceState enum and tracking to SyncState</name>
  <files>claude-tasks/src/state.rs</files>
  <action>
Add to state.rs:

1. **GuidanceState enum** (before SyncState struct):
```rust
/// Current guidance state for UX flow.
///
/// Determines what guidance todos (if any) should be displayed.
#[derive(Debug, Clone, PartialEq, Default)]
pub enum GuidanceState {
    /// No guidance shown - normal operation
    #[default]
    None,
    /// No tasklists exist at all
    NoTasklists,
    /// Tasklist exists but has no tasks yet
    EmptyTasklist,
    /// Error occurred with recovery guidance shown
    Error,
}
```

2. **New fields in SyncState**:
   - `guidance_state: GuidanceState` - current guidance state
   - `guidance_shown: bool` - whether guidance todos are currently displayed

3. **Methods on SyncState**:
   - `set_guidance(&mut self, state: GuidanceState)` - sets guidance_state and guidance_shown = true
   - `clear_guidance(&mut self)` - sets guidance_state = None, guidance_shown = false
   - `is_guidance_shown(&self) -> bool` - returns guidance_shown

Update SyncState::default() derivation to include new fields (both default to None/false).

Add tests for:
- GuidanceState default is None
- set_guidance sets both fields
- clear_guidance resets both fields
- is_guidance_shown returns correct value
  </action>
  <verify>cargo test --package claude-tasks state:: -- --nocapture</verify>
  <done>GuidanceState enum added, SyncState has tracking fields, all existing and new tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Export guidance module from lib.rs</name>
  <files>claude-tasks/src/lib.rs</files>
  <action>
Add module export for guidance:

1. Add `pub mod guidance;` after `pub mod errors;` (alphabetical order)

2. Verify module compiles as part of crate with: `cargo check --package claude-tasks`

No functional integration yet - that's Plan 03-02.
  </action>
  <verify>cargo check --package claude-tasks && cargo test --package claude-tasks</verify>
  <done>guidance module exported, crate compiles cleanly, all 78+ tests pass</done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
cargo test --package claude-tasks
```

Verify module exports:
```bash
cargo doc --package claude-tasks --no-deps
grep -r "pub fn create_no_tasklist_guidance" claude-tasks/src/
grep -r "GuidanceState" claude-tasks/src/
```

Expected: All tests pass, guidance module documented, GuidanceState accessible.
</verification>

<success_criteria>
- [ ] guidance.rs exists with 4 public functions and 9+ ID constants
- [ ] All guidance functions return valid FfiCommand sequences
- [ ] GuidanceState enum has 4 variants: None, NoTasklists, EmptyTasklist, Error
- [ ] SyncState has guidance_state and guidance_shown fields
- [ ] All existing tests still pass (78+)
- [ ] New tests for guidance module pass
- [ ] Crate compiles cleanly (no warnings)
</success_criteria>

<output>
After completion, create `.planning/phases/03-ux-polish/03-01-SUMMARY.md`
</output>
