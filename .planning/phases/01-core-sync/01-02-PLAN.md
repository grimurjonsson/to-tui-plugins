---
phase: 01-core-sync
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - claude-tasks/src/lib.rs
  - claude-tasks/src/discovery.rs
  - claude-tasks/src/watcher.rs
autonomous: true

must_haves:
  truths:
    - "Plugin discovers all tasklist folders in ~/.claude/tasks/"
    - "Each tasklist shows task count, last modified, and sample task names"
    - "File watcher thread starts on on_config_loaded and sends events via mpsc channel"
    - "Events are debounced at 200ms to handle rapid writes"
  artifacts:
    - path: "claude-tasks/src/discovery.rs"
      provides: "Tasklist discovery and metadata collection"
      exports: ["TasklistInfo", "discover_tasklists", "scan_tasks_directory"]
    - path: "claude-tasks/src/watcher.rs"
      provides: "File watcher setup with notify-debouncer-full"
      exports: ["start_watcher", "WatcherHandle"]
    - path: "claude-tasks/src/lib.rs"
      provides: "on_config_loaded spawns watcher thread"
      contains: "thread::spawn"
  key_links:
    - from: "claude-tasks/src/watcher.rs"
      to: "claude-tasks/src/state.rs"
      via: "mpsc channel sending SyncEvent"
      pattern: "tx.send\\(SyncEvent"
    - from: "claude-tasks/src/lib.rs"
      to: "claude-tasks/src/watcher.rs"
      via: "on_config_loaded calls start_watcher"
      pattern: "watcher::start_watcher"
---

<objective>
Implement tasklist discovery and file watching infrastructure with proper debouncing.

Purpose: Enable the plugin to find Claude tasklists and react to file system changes in real-time.
Output: Discovery module listing tasklists with metadata, watcher module spawning debounced file watcher thread.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-sync/01-RESEARCH.md
@.planning/phases/01-core-sync/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement tasklist discovery</name>
  <files>claude-tasks/src/discovery.rs</files>
  <action>
    Create discovery.rs with:

    1. TasklistInfo struct:
       - id: String (UUID folder name)
       - path: PathBuf (full path to tasklist folder)
       - task_count: usize (number of .json files)
       - last_modified: SystemTime
       - sample_tasks: Vec<String> (first 3 task subjects)

    2. discover_tasklists() -> Vec<TasklistInfo>:
       - Use dirs::home_dir() to get ~/.claude/tasks/
       - Read directory entries, filter to directories only
       - For each directory, call scan_tasks_directory to get task count and samples
       - Get last_modified from directory metadata
       - Sort results alphabetically by id (per CONTEXT.md decision)
       - Return empty vec if ~/.claude/tasks/ doesn't exist (not an error)

    3. scan_tasks_directory(path: &Path) -> Vec<ClaudeTask>:
       - Read all .json files in the directory
       - Parse each as ClaudeTask, skip parse failures silently
       - Sort by numeric id for consistent ordering

    Use the code examples from RESEARCH.md as reference. Handle all I/O errors gracefully without panicking.
  </action>
  <verify>
    cd claude-tasks && cargo check --lib
    # Manually verify: if ~/.claude/tasks/ exists, discovery should find folders
  </verify>
  <done>discover_tasklists() returns TasklistInfo for each tasklist folder with accurate metadata</done>
</task>

<task type="auto">
  <name>Task 2: Implement file watcher with debouncing</name>
  <files>claude-tasks/src/watcher.rs</files>
  <action>
    Create watcher.rs with:

    1. WatcherHandle struct:
       - thread_handle: Option<thread::JoinHandle<()>>
       - Used to track the watcher thread (cleanup in Phase 2)

    2. start_watcher(tasklist_path: PathBuf, tx: mpsc::Sender<SyncEvent>) -> Result<WatcherHandle, String>:
       - Create notify-debouncer-full with 200ms timeout (Duration::from_millis(200))
       - Use RecursiveMode::Recursive to watch subdirectories
       - In the debouncer callback:
         - For each debounced event, check event.kind
         - Create events: match for file changes (Modify, Create), translate to SyncEvent::FileChanged
         - Remove events: match for file removal (Remove), translate to SyncEvent::FileRemoved
         - Send events via tx.send(), ignore send errors (receiver might be dropped)
       - Watch the tasklist_path directory
       - Spawn thread that keeps debouncer alive (loop with thread::park())
       - Return WatcherHandle with the thread handle

    Key patterns from RESEARCH.md:
    - Watch DIRECTORIES not files (handles atomic writes)
    - Use notify-debouncer-full NOT notify-debouncer-mini
    - 200ms debounce timeout balances responsiveness with event merging
    - Send minimal event to channel, heavy processing happens in main thread

    Filter events to only .json files in the callback.
  </action>
  <verify>
    cd claude-tasks && cargo check --lib
  </verify>
  <done>start_watcher spawns debounced file watcher thread, sends SyncEvent through channel</done>
</task>

<task type="auto">
  <name>Task 3: Wire discovery and watcher into Plugin</name>
  <files>claude-tasks/src/lib.rs</files>
  <action>
    Update lib.rs:

    1. Add module declarations:
       - mod discovery;
       - mod watcher;

    2. Update ClaudeTasksPlugin struct:
       - Add watcher_handle: Mutex<Option<watcher::WatcherHandle>>

    3. Implement on_config_loaded():
       - Call discovery::discover_tasklists()
       - If no tasklists found, log warning and return (plugin remains dormant)
       - For now, auto-select first tasklist (selection UI deferred - keep simple)
       - Store selected tasklist path in state
       - Create mpsc channel
       - Store rx in self.rx
       - Call watcher::start_watcher with tasklist path and tx clone
       - Store watcher handle
       - Send SyncEvent::InitialScan through channel to trigger first sync

    4. Update subscribed_events():
       - Subscribe to FfiEventType::OnLoad (already done in Plan 01)

    Discovery output is logged for debugging. Full selection UI is Phase 2 scope (PLUG-05).
    For Phase 1, auto-select first discovered tasklist to keep the sync loop simple.
  </action>
  <verify>
    cd claude-tasks && cargo build --release
  </verify>
  <done>Plugin discovers tasklists on config load, spawns watcher for first tasklist, channel ready for events</done>
</task>

</tasks>

<verification>
1. `cargo build --release` succeeds
2. Discovery finds tasklists if ~/.claude/tasks/ exists with subfolders
3. Watcher thread starts without blocking plugin initialization
4. SyncEvent can be sent through channel (unit test or manual verification)
5. No panics when ~/.claude/tasks/ is empty or missing
</verification>

<success_criteria>
- discover_tasklists() returns accurate TasklistInfo for each folder in ~/.claude/tasks/
- scan_tasks_directory() parses ClaudeTask JSON files correctly
- File watcher uses notify-debouncer-full with 200ms timeout
- Watcher thread spawns on plugin config load
- Events flow through mpsc channel from watcher to main thread
- Plugin handles missing/empty ~/.claude/tasks/ gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-sync/01-02-SUMMARY.md`
</output>
