---
phase: 02-robustness-and-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - claude-tasks/src/config.rs
  - claude-tasks/src/lib.rs
  - claude-tasks/src/commands.rs
  - claude-tasks/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Plugin loads aliases from global config (~/.config/totui/claude-tasks.toml)"
    - "Plugin loads aliases from local config (.totui/aliases.toml) that override global"
    - "Header todo displays alias name instead of UUID when alias is configured"
    - "Tasklist selection shows 'Alias (a1b2c3...)' format"
  artifacts:
    - path: "claude-tasks/src/config.rs"
      provides: "PluginConfig struct with aliases HashMap and load_config function"
      min_lines: 50
    - path: "claude-tasks/Cargo.toml"
      provides: "toml dependency"
      contains: "toml"
  key_links:
    - from: "claude-tasks/src/lib.rs"
      to: "config::load_config"
      via: "Config loading in on_config_loaded"
      pattern: "load_config"
    - from: "claude-tasks/src/commands.rs"
      to: "alias resolution"
      via: "format_tasklist_display or alias parameter"
      pattern: "alias|display_name"
---

<objective>
Add TOML configuration support with tasklist aliases and staleness threshold settings.

Purpose: Users want friendly names for tasklist UUIDs (DISC-03) and configurable staleness detection (PLUG-05). Configuration enables user customization without code changes.

Output: New config.rs module with PluginConfig struct, TOML loading with merge semantics, alias resolution in display functions.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-robustness-and-features/02-RESEARCH.md
@.planning/phases/02-robustness-and-features/02-CONTEXT.md

# Existing source files
@claude-tasks/src/lib.rs
@claude-tasks/src/commands.rs
@claude-tasks/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toml dependency and create config module</name>
  <files>claude-tasks/Cargo.toml, claude-tasks/src/config.rs</files>
  <action>
1. Add toml dependency to Cargo.toml:
   ```toml
   [dependencies]
   # Add after existing dependencies
   toml = "0.8"
   ```

2. Create new `config.rs` module:

   ```rust
   //! Plugin configuration loading and alias resolution.
   //!
   //! Configuration is loaded from two locations:
   //! - Global: ~/.config/totui/claude-tasks.toml
   //! - Local: .totui/aliases.toml (overrides global)

   use serde::{Deserialize, Serialize};
   use std::collections::HashMap;
   use std::path::PathBuf;

   /// Plugin configuration.
   #[derive(Debug, Default, Deserialize, Serialize, Clone)]
   pub struct PluginConfig {
       /// UUID -> friendly name mappings
       #[serde(default)]
       pub aliases: HashMap<String, String>,
       /// Staleness threshold in minutes (default: 15)
       #[serde(default)]
       pub staleness_threshold_minutes: Option<u64>,
   }

   impl PluginConfig {
       /// Get staleness threshold, defaulting to 15 minutes
       pub fn staleness_threshold(&self) -> u64 {
           self.staleness_threshold_minutes.unwrap_or(15)
       }

       /// Get alias for a tasklist UUID, if configured
       pub fn get_alias(&self, uuid: &str) -> Option<&str> {
           self.aliases.get(uuid).map(|s| s.as_str())
       }
   }

   /// Load configuration from global and local paths.
   ///
   /// Global config: ~/.config/totui/claude-tasks.toml
   /// Local config: .totui/aliases.toml (overrides global)
   pub fn load_config() -> PluginConfig {
       let mut config = PluginConfig::default();

       // Load global config
       if let Some(global_path) = global_config_path() {
           if global_path.exists() {
               if let Ok(content) = std::fs::read_to_string(&global_path) {
                   if let Ok(global) = toml::from_str::<PluginConfig>(&content) {
                       config = global;
                   }
               }
           }
       }

       // Merge local config (overrides global)
       let local_path = local_config_path();
       if local_path.exists() {
           if let Ok(content) = std::fs::read_to_string(&local_path) {
               if let Ok(local) = toml::from_str::<PluginConfig>(&content) {
                   // Merge aliases - local overrides global
                   config.aliases.extend(local.aliases);
                   // Override staleness if specified
                   if local.staleness_threshold_minutes.is_some() {
                       config.staleness_threshold_minutes = local.staleness_threshold_minutes;
                   }
               }
           }
       }

       config
   }

   /// Get global config path: ~/.config/totui/claude-tasks.toml
   fn global_config_path() -> Option<PathBuf> {
       dirs::config_dir().map(|p| p.join("totui").join("claude-tasks.toml"))
   }

   /// Get local config path: .totui/aliases.toml
   fn local_config_path() -> PathBuf {
       PathBuf::from(".totui").join("aliases.toml")
   }

   /// Format tasklist display with alias if available.
   ///
   /// Returns "Alias (a1b2c3...)" if alias exists, otherwise just UUID.
   pub fn format_tasklist_display(uuid: &str, config: &PluginConfig) -> String {
       match config.get_alias(uuid) {
           Some(alias) => {
               let short_uuid = &uuid[..8.min(uuid.len())];
               format!("{} ({}...)", alias, short_uuid)
           }
           None => uuid.to_string()
       }
   }
   ```

3. Add module to lib.rs: `pub mod config;`
  </action>
  <verify>
cargo check in claude-tasks directory passes.
cargo test should still pass (no breaking changes).
  </verify>
  <done>
config.rs exists with PluginConfig struct, load_config function that merges global and local config, and format_tasklist_display for alias resolution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate config into plugin and update header display</name>
  <files>claude-tasks/src/lib.rs, claude-tasks/src/commands.rs, claude-tasks/src/state.rs</files>
  <action>
1. Update state.rs to include config:
   - Add `use crate::config::PluginConfig;`
   - Add field to SyncState: `pub config: PluginConfig,`
   - Update Default impl to include `config: PluginConfig::default()`

2. Update lib.rs on_config_loaded:
   - Add `use crate::config::{load_config, format_tasklist_display};`
   - At start of on_config_loaded, load config:
     ```rust
     let config = load_config();
     ```
   - Store config in state:
     ```rust
     {
         let mut state = self.state.lock().unwrap();
         state.config = config.clone();
     }
     ```
   - Update log message to use format_tasklist_display:
     ```rust
     let display_name = format_tasklist_display(&selected.id, &config);
     eprintln!(
         "claude-tasks: Found {} tasklist(s), auto-selecting: {} ({} tasks)",
         tasklists.len(),
         display_name,
         selected.task_count
     );
     ```

3. Update commands.rs create_header_command to accept optional alias:
   ```rust
   /// Create a header todo command for a tasklist.
   ///
   /// Header format: "CLAUDE TASKLIST: {display_name}"
   /// where display_name is alias or UUID
   pub fn create_header_command(tasklist_id: &str, display_name: Option<&str>) -> FfiCommand {
       let name = display_name.unwrap_or(tasklist_id);
       FfiCommand::CreateTodo {
           content: RString::from(format!("CLAUDE TASKLIST: {}", name)),
           parent_id: ROption::RNone,
           temp_id: ROption::RSome(RString::from(format!("claude-header-{}", tasklist_id))),
           state: FfiTodoState::Empty,
           priority: ROption::RNone,
           indent_level: 0,
       }
   }
   ```

4. Update sync.rs process_initial_scan_local to pass alias:
   - Change function signature to accept `alias: Option<&str>`
   - Pass alias to create_header_command

5. Update lib.rs process_sync_events_local to get alias from config:
   - In InitialScan handler:
     ```rust
     let alias = {
         let state = self.state.lock().unwrap();
         state.config.get_alias(&tasklist_id).map(|s| s.to_string())
     };
     let (cmds, task_ids) = sync::process_initial_scan_local(
         &tasklist_path,
         &tasklist_id,
         alias.as_deref()
     );
     ```
  </action>
  <verify>
cargo test passes all tests including existing sync tests.
cargo check shows no warnings.
  </verify>
  <done>
Config is loaded in on_config_loaded, stored in state, and used to display friendly names in header todo and selection log.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add config tests</name>
  <files>claude-tasks/src/config.rs</files>
  <action>
Add tests to config.rs:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_plugin_config_default() {
        let config = PluginConfig::default();
        assert!(config.aliases.is_empty());
        assert!(config.staleness_threshold_minutes.is_none());
        assert_eq!(config.staleness_threshold(), 15); // default
    }

    #[test]
    fn test_staleness_threshold_custom() {
        let config = PluginConfig {
            staleness_threshold_minutes: Some(30),
            ..Default::default()
        };
        assert_eq!(config.staleness_threshold(), 30);
    }

    #[test]
    fn test_get_alias() {
        let mut config = PluginConfig::default();
        config.aliases.insert("abc-123".to_string(), "MyProject".to_string());

        assert_eq!(config.get_alias("abc-123"), Some("MyProject"));
        assert_eq!(config.get_alias("xyz-789"), None);
    }

    #[test]
    fn test_format_tasklist_display_with_alias() {
        let mut config = PluginConfig::default();
        config.aliases.insert("abc-123-def-456".to_string(), "MyProject".to_string());

        let display = format_tasklist_display("abc-123-def-456", &config);
        assert_eq!(display, "MyProject (abc-123-...)");
    }

    #[test]
    fn test_format_tasklist_display_no_alias() {
        let config = PluginConfig::default();
        let display = format_tasklist_display("abc-123", &config);
        assert_eq!(display, "abc-123");
    }

    #[test]
    fn test_parse_toml_config() {
        let toml = r#"
            staleness_threshold_minutes = 20

            [aliases]
            "abc-123" = "Project A"
            "def-456" = "Project B"
        "#;

        let config: PluginConfig = toml::from_str(toml).unwrap();
        assert_eq!(config.staleness_threshold(), 20);
        assert_eq!(config.get_alias("abc-123"), Some("Project A"));
        assert_eq!(config.get_alias("def-456"), Some("Project B"));
    }

    #[test]
    fn test_parse_empty_toml() {
        let config: PluginConfig = toml::from_str("").unwrap();
        assert!(config.aliases.is_empty());
        assert_eq!(config.staleness_threshold(), 15);
    }
}
```
  </action>
  <verify>
cargo test in claude-tasks passes all config tests.
  </verify>
  <done>
Config module has comprehensive tests for default values, alias lookup, display formatting, and TOML parsing.
  </done>
</task>

</tasks>

<verification>
1. `cd claude-tasks && cargo test` - All tests pass including new config tests
2. `cargo clippy -- -D warnings` - No warnings
3. `cargo build --release` - Builds with toml dependency
4. Create test config file and verify it loads correctly
</verification>

<success_criteria>
- toml 0.8 added to Cargo.toml dependencies
- PluginConfig struct with aliases HashMap and staleness_threshold_minutes
- load_config merges global ~/.config/totui/claude-tasks.toml with local .totui/aliases.toml
- format_tasklist_display returns "Alias (a1b2c3...)" when alias configured
- Header todo shows alias instead of UUID when configured
- All tests pass including config loading and TOML parsing
</success_criteria>

<output>
After completion, create `.planning/phases/02-robustness-and-features/02-02-SUMMARY.md`
</output>
